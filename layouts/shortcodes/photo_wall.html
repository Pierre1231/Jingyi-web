{{- $album := .Get "images" | default "photography" -}}
{{- $photoFiles := slice "1.JPG" "2.jpg" "3.jpg" "4.jpg" "5.jpg" "6.jpg" "7.jpg" "8.jpg" "9.jpg" -}}

<div class="justified-gallery-container">
  <div class="justified-gallery" id="justifiedGallery">
    {{- range $photoFiles -}}
      {{- $imgPath := printf "/media/albums/%s/%s" $album . -}}
      <div class="jg-item">
        <img src="{{ $imgPath }}" alt="Photography" loading="lazy" />
      </div>
    {{- end -}}
  </div>
</div>

<script>
(function() {
  'use strict';
  
  function layoutJustifiedGallery() {
    const gallery = document.getElementById('justifiedGallery');
    if (!gallery) return;
    
    const items = Array.from(gallery.querySelectorAll('.jg-item'));
    if (items.length === 0) return;
    
    const containerWidth = gallery.offsetWidth;
    if (containerWidth <= 0) return;
    
    const isMobile = window.innerWidth < 768;
    const targetRowHeight = isMobile ? 200 : 280;
    const margin = isMobile ? 6 : 8;
    
    // Wait for all images to have dimensions
    const images = items.map(item => item.querySelector('img'));
    const checkImages = () => {
      const allReady = images.every(img => {
        return img.complete && img.naturalWidth > 0 && img.naturalHeight > 0;
      });
      
      if (allReady) {
        doLayout();
      } else {
        // Set up load handlers
        let loaded = 0;
        images.forEach(img => {
          if (img.complete && img.naturalWidth > 0) {
            loaded++;
          } else {
            const onLoad = () => {
              loaded++;
              if (loaded === images.length) {
                doLayout();
              }
            };
            img.addEventListener('load', onLoad, { once: true });
            img.addEventListener('error', onLoad, { once: true });
          }
        });
        
        if (loaded === images.length) {
          doLayout();
        }
      }
    };
    
    function doLayout() {
      // Reset styles
      items.forEach(item => {
        item.style.cssText = '';
        const img = item.querySelector('img');
        img.style.cssText = '';
      });
      
      const rows = [];
      let currentRow = [];
      let currentRowWidth = 0;
      
      items.forEach((item, index) => {
        const img = item.querySelector('img');
        if (!img.naturalWidth || !img.naturalHeight) {
          // Skip invalid images
          if (index === items.length - 1 && currentRow.length > 0) {
            rows.push(currentRow);
          }
          return;
        }
        
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        const itemWidth = targetRowHeight * aspectRatio;
        const spacing = currentRow.length > 0 ? margin : 0;
        const newRowWidth = currentRowWidth + itemWidth + spacing;
        
        if (newRowWidth > containerWidth && currentRow.length > 0) {
          rows.push([...currentRow]);
          currentRow = [item];
          currentRowWidth = itemWidth;
        } else {
          currentRow.push(item);
          currentRowWidth = newRowWidth;
        }
        
        if (index === items.length - 1 && currentRow.length > 0) {
          rows.push(currentRow);
        }
      });
      
      // Apply layout to each row
      rows.forEach((row, rowIndex) => {
        const aspectRatioSum = row.reduce((sum, item) => {
          const img = item.querySelector('img');
          return sum + (img.naturalWidth / img.naturalHeight);
        }, 0);
        
        if (aspectRatioSum === 0) return;
        
        const availableWidth = containerWidth - (row.length - 1) * margin;
        
        row.forEach((item, itemIndex) => {
          const img = item.querySelector('img');
          const aspectRatio = img.naturalWidth / img.naturalHeight;
          const width = Math.floor((aspectRatio / aspectRatioSum) * availableWidth);
          
          item.style.cssText = `
            width: ${width}px;
            height: ${targetRowHeight}px;
            margin-right: ${itemIndex < row.length - 1 ? margin : 0}px;
            margin-bottom: ${rowIndex < rows.length - 1 ? margin : 0}px;
            display: inline-block;
            vertical-align: top;
            overflow: hidden;
          `;
          
          img.style.cssText = `
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
          `;
        });
      });
    }
    
    checkImages();
  }
  
  // Initialize
  function init() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(layoutJustifiedGallery, 100);
      });
    } else {
      setTimeout(layoutJustifiedGallery, 100);
    }
  }
  
  init();
  
  // Handle resize
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(layoutJustifiedGallery, 300);
  });
  
  // Re-layout when all images loaded
  window.addEventListener('load', () => {
    setTimeout(layoutJustifiedGallery, 200);
  });
})();
</script>

