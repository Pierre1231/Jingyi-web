{{ define "main" }}
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1>{{ .Title }}</h1>
      {{ if .Description }}
      <div class="gallery-description">
        <p>{{ .Description }}</p>
      </div>
      {{ end }}
      
      {{ partial "gallery.html" . }}
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe.css" />
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" async></script>
<script type="module">
  import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe-lightbox.esm.js';
  import PhotoSwipe from 'https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe.esm.js';

  function initPhotoSwipe() {
    const gallery = document.getElementById('gallery');
    if (!gallery) {
      console.error('Gallery container not found');
      return;
    }

    const galleryItems = gallery.querySelectorAll('a.gallery-item');
    if (galleryItems.length === 0) {
      console.error('No gallery items found');
      return;
    }

    console.log('Initializing PhotoSwipe with', galleryItems.length, 'items');

    // 构建图片数据数组
    const items = Array.from(galleryItems).map(item => {
      const src = item.getAttribute('data-pswp-src') || item.href;
      const width = parseInt(item.getAttribute('data-pswp-width')) || 1600;
      const height = parseInt(item.getAttribute('data-pswp-height')) || 1200;
      const title = item.getAttribute('title') || '';
      
      return {
        src: src,
        width: width,
        height: height,
        title: title
      };
    });

    // 创建 lightbox 实例
    const lightbox = new PhotoSwipeLightbox({
      dataSource: items,
      pswpModule: PhotoSwipe,
      showHideAnimationType: 'fade',
      bgOpacity: 0.9,
      closeTitle: 'Close (Esc)',
      zoomTitle: 'Zoom in/out',
      arrowPrevTitle: 'Previous (arrow left)',
      arrowNextTitle: 'Next (arrow right)',
      returnFocus: true,
      tapToClose: true,
      swipeToClose: true,
      // 禁用缩放按钮
      zoom: false,
      // 调整过渡动画时长
      initialZoomFactor: 1,
      secondaryZoomLevel: 1,
      maxZoomLevel: 1,
      // 添加其他过渡效果参数，例如动画时长
      speed: 300,
      // 增加拖拽灵敏度，使切换更平滑
      pinchToClose: false // 禁用双指缩放关闭，与放大镜禁用一致
    });

    // 初始化 lightbox
    lightbox.init();

    // 为每个图片链接绑定点击事件
    galleryItems.forEach((item, index) => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Opening photo at index:', index);
        lightbox.loadAndOpen(index);
        return false;
      });
    });

    console.log('PhotoSwipe initialized successfully');
  }

  // 等待 DOM 加载完成
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initPhotoSwipe, 100);
    });
  } else {
    // DOM 已经加载完成，稍微延迟以确保所有元素都已渲染
    setTimeout(initPhotoSwipe, 100);
  }
</script>

<style>
.gallery {
  margin-top: 2rem;
}

#gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
}

.gallery-item {
  display: block;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  text-decoration: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.gallery-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.gallery-item figure {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  position: relative;
  overflow: hidden;
}

.gallery-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform 0.3s ease;
  image-orientation: from-image;
}

.gallery-item:hover img {
  transform: scale(1.05);
}

.gallery-description {
  margin: 1rem 0 2rem 0;
  font-size: 1.1rem;
  line-height: 1.6;
  color: #666;
}

@media (max-width: 768px) {
  #gallery {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.75rem;
  }
}

@media (max-width: 480px) {
  #gallery {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.5rem;
  }
}

</style>
{{ end }}
