{{ define "main" }}
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1>{{ .Title }}</h1>
      {{ if .Description }}
      <div class="gallery-description">
        <p>{{ .Description }}</p>
      </div>
      {{ end }}
      
      {{ partial "gallery.html" . }}
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe.css" />
<script type="module">
  import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe-lightbox.esm.js';
  import PhotoSwipe from 'https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#gallery',
    children: 'a.gallery-item',
    pswpModule: PhotoSwipe,
    showHideAnimationType: 'fade',
    bgOpacity: 0.9
  });

  lightbox.on('loadComplete', (e) => {
    const { content } = e;
    const item = content.data;
    if (item.pswpWidth && item.pswpHeight) {
      content.width = item.pswpWidth;
      content.height = item.pswpHeight;
    }
  });

  lightbox.on('itemData', (e) => {
    const linkEl = e.item.element;
    if (linkEl) {
      e.itemData.src = linkEl.getAttribute('data-pswp-src') || linkEl.href;
      const width = parseInt(linkEl.getAttribute('data-pswp-width'));
      const height = parseInt(linkEl.getAttribute('data-pswp-height'));
      if (width && height) {
        e.itemData.width = width;
        e.itemData.height = height;
      }
      e.itemData.title = linkEl.getAttribute('title') || '';
    }
  });

  lightbox.init();
</script>

<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" async></script>

<style>
.gallery {
  margin-top: 2rem;
}

#gallery {
  position: relative;
  min-height: 200px;
}

.gallery-item {
  display: block;
  position: absolute;
  width: calc(25% - 3px);
  cursor: pointer;
  text-decoration: none;
  transition: opacity 0.2s ease;
  opacity: 1;
  visibility: visible;
}

.gallery-item:hover {
  opacity: 0.9;
}

.gallery-item figure {
  margin: 0;
  padding: 0;
  width: 100%;
  position: relative;
  overflow: hidden;
}

.gallery-item img {
  width: 100%;
  height: auto;
  display: block;
  vertical-align: bottom;
}

.gallery-description {
  margin: 1rem 0 2rem 0;
  font-size: 1.1rem;
  line-height: 1.6;
  color: #666;
}

/* 5 columns on large screens */
@media (min-width: 1400px) {
  .gallery-item {
    width: calc(20% - 3.2px);
  }
}

/* 4 columns on medium-large screens (default) */
@media (min-width: 1024px) and (max-width: 1399px) {
  .gallery-item {
    width: calc(25% - 3px);
  }
}

/* 3 columns on tablets */
@media (min-width: 768px) and (max-width: 1023px) {
  .gallery-item {
    width: calc(33.333% - 2.67px);
  }
}

/* 2 columns on small tablets */
@media (min-width: 480px) and (max-width: 767px) {
  .gallery-item {
    width: calc(50% - 2px);
  }
}

/* 1 column on mobile */
@media (max-width: 479px) {
  .gallery-item {
    width: 100%;
  }
}
</style>

<script>
(function() {
  function initMasonry() {
    const gallery = document.getElementById('gallery');
    if (!gallery) return;

    const items = Array.from(gallery.querySelectorAll('.gallery-item'));
    if (items.length === 0) return;

    // Calculate number of columns based on screen width
    function getColumns() {
      const width = window.innerWidth;
      if (width >= 1400) return 5;
      if (width >= 1024) return 4;
      if (width >= 768) return 3;
      if (width >= 480) return 2;
      return 1;
    }

    function getImageHeight(img, columnWidth) {
      if (img.naturalWidth && img.naturalHeight) {
        return (img.naturalHeight / img.naturalWidth) * columnWidth;
      }
      if (img.offsetHeight && img.offsetWidth) {
        return (img.offsetHeight / img.offsetWidth) * columnWidth;
      }
      // Fallback: assume square
      return columnWidth;
    }

    function layoutMasonry() {
      const columns = getColumns();
      const gap = 2; // 2px gap
      
      // Make sure gallery is visible
      gallery.style.visibility = 'visible';
      gallery.style.height = 'auto';
      gallery.style.overflow = 'visible';
      
      // Wait for gallery to have width
      if (gallery.offsetWidth === 0) {
        setTimeout(layoutMasonry, 50);
        return;
      }
      
      const columnWidth = (gallery.offsetWidth - (gap * (columns - 1))) / columns;
      
      // Reset positions
      items.forEach(item => {
        item.style.width = columnWidth + 'px';
        item.style.position = 'absolute';
        item.style.visibility = 'visible';
      });

      // Calculate column heights
      const columnHeights = new Array(columns).fill(0);
      
      items.forEach((item) => {
        // Find the shortest column
        const shortestColumnIndex = columnHeights.indexOf(Math.min(...columnHeights));
        
        // Position the item
        const left = shortestColumnIndex * (columnWidth + gap);
        const top = columnHeights[shortestColumnIndex];
        
        item.style.left = left + 'px';
        item.style.top = top + 'px';
        
        // Update column height
        const img = item.querySelector('img');
        const itemHeight = getImageHeight(img, columnWidth);
        columnHeights[shortestColumnIndex] += itemHeight + gap;
      });
      
      // Set gallery height
      const maxHeight = Math.max(...columnHeights);
      if (maxHeight > 0) {
        gallery.style.height = maxHeight + 'px';
      }
    }

    // Function to handle image loading
    function handleImageLoad() {
      layoutMasonry();
    }

    // Wait for images to load and handle lazysizes
    items.forEach(item => {
      const img = item.querySelector('img');
      
      // If image is already loaded
      if (img.complete && img.naturalWidth > 0) {
        return;
      }
      
      // Listen for lazysizes loaded event
      img.addEventListener('lazyloaded', handleImageLoad);
      
      // Fallback: listen for regular load event
      img.addEventListener('load', handleImageLoad);
      
      // Also listen for error
      img.addEventListener('error', handleImageLoad);
    });

    // Layout on window resize
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(layoutMasonry, 250);
    });

    // Initial layout (will be refined as images load)
    // Use requestAnimationFrame to ensure DOM is ready
    requestAnimationFrame(function() {
      setTimeout(layoutMasonry, 100);
    });
    
    // Re-layout after images load
    setTimeout(layoutMasonry, 300);
    setTimeout(layoutMasonry, 800);
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMasonry);
  } else {
    initMasonry();
  }
})();
</script>
{{ end }}
