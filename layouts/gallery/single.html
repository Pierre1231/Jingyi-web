{{ define "main" }}
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1>{{ .Title }}</h1>
      {{ if .Description }}
      <div class="gallery-description">
        <p>{{ .Description }}</p>
      </div>
      {{ end }}
      
      {{ partial "gallery.html" . }}
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe.css" />
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js" async></script>
<script type="module">
  import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe-lightbox.esm.js';
  import PhotoSwipe from 'https://cdn.jsdelivr.net/npm/photoswipe@5.3.4/dist/photoswipe.esm.js';

  function initPhotoSwipe() {
    const gallery = document.getElementById('gallery');
    if (!gallery) {
      return;
    }

    const lightbox = new PhotoSwipeLightbox({
      gallery: '#gallery',
      children: 'a.gallery-item',
      pswpModule: PhotoSwipe,
      showHideAnimationType: 'fade',
      bgOpacity: 0.9,
      closeTitle: 'Close (Esc)',
      zoomTitle: 'Zoom in/out',
      arrowPrevTitle: 'Previous (arrow left)',
      arrowNextTitle: 'Next (arrow right)',
      returnFocus: true,
      tapToClose: true,
      swipeToClose: true
    });

    // 处理 itemData 事件，从 data 属性中获取图片信息
    lightbox.on('itemData', (e) => {
      const linkEl = e.item.element;
      if (linkEl) {
        // 优先使用 data-pswp-src，否则使用 href
        const src = linkEl.getAttribute('data-pswp-src') || linkEl.href;
        e.itemData.src = src;
        
        const width = parseInt(linkEl.getAttribute('data-pswp-width'));
        const height = parseInt(linkEl.getAttribute('data-pswp-height'));
        if (width && height) {
          e.itemData.width = width;
          e.itemData.height = height;
        } else {
          // 如果没有提供尺寸，使用默认值
          e.itemData.width = 1600;
          e.itemData.height = 1200;
        }
        
        const title = linkEl.getAttribute('title') || '';
        if (title) {
          e.itemData.title = title;
        }
      }
    });

    lightbox.init();
  }

  // 等待 DOM 加载完成
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPhotoSwipe);
  } else {
    // DOM 已经加载完成
    initPhotoSwipe();
  }
</script>

<style>
.gallery {
  margin-top: 2rem;
}

#gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
}

.gallery-item {
  display: block;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  text-decoration: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.gallery-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.gallery-item figure {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  position: relative;
  overflow: hidden;
}

.gallery-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform 0.3s ease;
}

.gallery-item:hover img {
  transform: scale(1.05);
}

.gallery-description {
  margin: 1rem 0 2rem 0;
  font-size: 1.1rem;
  line-height: 1.6;
  color: #666;
}

@media (max-width: 768px) {
  #gallery {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.75rem;
  }
}

@media (max-width: 480px) {
  #gallery {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.5rem;
  }
}

/* PhotoSwipe 自定义样式 - 确保关闭按钮和箭头清晰可见 */
.pswp__button--close {
  background-color: rgba(0, 0, 0, 0.5) !important;
  border-radius: 50% !important;
  width: 44px !important;
  height: 44px !important;
  margin: 10px !important;
  opacity: 0.9 !important;
}

.pswp__button--close:hover {
  opacity: 1 !important;
  background-color: rgba(0, 0, 0, 0.7) !important;
}

.pswp__button--arrow--prev,
.pswp__button--arrow--next {
  background-color: rgba(0, 0, 0, 0.5) !important;
  border-radius: 50% !important;
  width: 44px !important;
  height: 44px !important;
  opacity: 0.9 !important;
}

.pswp__button--arrow--prev:hover,
.pswp__button--arrow--next:hover {
  opacity: 1 !important;
  background-color: rgba(0, 0, 0, 0.7) !important;
}

.pswp__button--arrow--prev {
  left: 10px !important;
}

.pswp__button--arrow--next {
  right: 10px !important;
}

/* 确保关闭按钮和箭头图标清晰可见 */
.pswp__button--close svg,
.pswp__button--arrow--prev svg,
.pswp__button--arrow--next svg {
  fill: white !important;
  width: 24px !important;
  height: 24px !important;
}
</style>
{{ end }}
