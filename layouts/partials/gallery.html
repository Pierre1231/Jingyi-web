<section class="gallery">
  <div id="gallery">
    {{ $images := slice }}
    {{ range $image := where (.Resources.ByType "image") "Params.hidden" "ne" true }}
      {{ $title := "" }}
      {{ $date := "" }}
      {{ with $image.Exif }}
        {{ $date = .Date }}
        {{ with .Tags.ImageDescription }}
          {{ $title = . }}
        {{ end }}
      {{ end }}
      {{ if ne $image.Title $image.Name }}
        {{ $title = $image.Title }}
      {{ end }}
      {{ if $image.Params.Date }}
        {{ $date = time $image.Params.Date }}
      {{ end }}
      {{ $images = $images | append (dict
        "Name" $image.Name
        "Title" $title
        "Date" $date
        "image" $image
        "Params" $image.Params
        )
      }}
    {{ end }}
    {{ $publishResources := default true .Params.build.publishResources }}
    {{/* 按日期倒序排列，最新的在前。如果没有日期，使用文件修改时间 */}}
    {{ $sortedImages := sort $images "Date" "desc" }}
    {{/* 如果 Date 为空，使用文件修改时间作为后备 */}}
    {{ range $sortedImages }}
      {{ $image := .image }}
      {{ $thumbnail := $image.Fill "600x600" }}
      {{ $full := $image.Fit "1600x1600" }}
      {{ $color := "#f0f0f0" }}
      {{ if $thumbnail }}
        {{ $aspectRatio := div (float $thumbnail.Width) $thumbnail.Height }}
        <a class="gallery-item" href="{{ $full.RelPermalink }}" data-pswp-src="{{ $full.RelPermalink }}" data-pswp-width="{{ $full.Width }}" data-pswp-height="{{ $full.Height }}" itemscope itemtype="https://schema.org/ImageObject" style="aspect-ratio: {{ $aspectRatio }}">
          <figure style="background-color: {{ $color }}; aspect-ratio: {{ $aspectRatio }}">
            <img class="lazyload" width="{{ $thumbnail.Width }}" height="{{ $thumbnail.Height }}" data-src="{{ $thumbnail.RelPermalink }}" src="{{ $thumbnail.RelPermalink }}" alt="{{ .Title }}" />
          </figure>
          <meta itemprop="contentUrl" content="{{ if $publishResources }}{{ $image.RelPermalink }}{{ else }}{{ $full.RelPermalink }}{{ end }}" />
          {{ with site.Params.Author }}
            <span itemprop="creator" itemtype="https://schema.org/Person" itemscope>
              <meta itemprop="name" content="{{ site.Params.Author.name }}" />
            </span>
          {{ end }}
        </a>
      {{ end }}
    {{ end }}
  </div>
</section>

